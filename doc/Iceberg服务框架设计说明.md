# 前言
服务层将按照微服务架构的思想来实现。这样我们将会有数量可观的独立的服务程序。这些服务都专注于解决特定的业务问题，但做为独立的服务程序，诸如连接管理，信号处理，横向扩展等功能都是可以共用的。所以这篇《Iceberg服务框架设计说明》的目的就是描述实现这些在各个服务之间公用功能的设计思路。

## 缩略语及名词解释
- iceberg

	服务层的统称。iceberg意为冰山，意味着服务层向外部提供简练的接口来提供各种业务的支持。这些简练的接口就像海面上的冰山一角，隐藏在水面下的是服务层里众多的服务和数据。

- etcd
	
  一个开源的基于Raft算法的分布式一致性解决方案。它受zookeeper的理念影响，提供和zookeeper类型的功能和数据模型。用go语言实现。
  
- 服务体系
 
  服务层的服务的拓扑关系。同时还包含了服务层RESTful接口和服务之间的对应关系。详见《Iceberg服务发现系统说明.md》
  
- 一致性哈希(consistent hash)(暂时去掉此功能)

  提供分布式集群环境下的负载均衡和横向扩展能力的一种基础手段。
  
- goroutine

  协程，Go语言中的基本并发单位。
  
- panic

  Go语言中的异常，未被处理的panic会导致进程崩溃。


# 概述
Iceberg服务程序会尽量以集群的形式部署，用多并发的方法来处理请求。

- 关于集群，我们通过一致性哈希和服务注册，发现机制来实现
- 关于多并发，利用Go语言的协程能力，结合Pipeline的思想来实现

## 设计目标
- 高性能
- 高可用
- 可扩展性

### Features
- 负载均衡
- 动态的服务发现
- 连接池
- 编码自动化

#	依赖
## 硬件平台
X86 服务器

## 软件平台
- CentOS 6.2 
- etcd 2.2.1 参见 缩略语及名词解释 中的说明

# 软件结构
##	语言
Golang 1.8 OR Up

## 模块说明
### 服务发现
服务发现模块作为etcd的客户端，监听etcd上新服务的注册，实例数量的变更来更新本地的服务器拓扑结构。

该模块主要维护一个map数据结构。map的key是RESTful接口的uri（通常是一个目录），代表了一类服务接口。value是一个一致性哈希环。这个哈希环当中的节点就是实现uri所代表的服务的程序实例的连接池。

当程序要向其他服务发送请求时，只要通过服务发现模块提供的接口就能得到到达合适的实例的TCP连接。

### 一致性哈希
该模块维护各服务实例节点组成的一个列表。这个列表按照hash算法的结果升序组织。在逻辑上我们把这个列表当作一个环来看待。

该模块还提供根据请求的ID计算和在哈希环中查找实例的功能。

目前只提供了一种哈希算法。先计算ID的md5，然后提取结果的前4个byte做为一个uint32的整数。

### 连接池
维护程序自身和其他服务程序之间的TCP长连接。断线的会自动重连。

# 附件
无